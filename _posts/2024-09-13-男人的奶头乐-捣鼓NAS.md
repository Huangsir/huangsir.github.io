---
layout: post
title: "男人的奶头乐-捣鼓NAS"
date: "2024-09-13"
categories: [日志]
---

### 背景

老婆经常要看剧，所以我懂。  
原本有一个RaspberryPI和一个CubieTruck，但是自从Cubie倒闭以后CubieTruck就越来越不稳定，经常无故死机。PI又没有原装SATA，搞起来比较蛋疼。  
原本也舍不得要买个NAS，感觉不实用，后来因为下载太多，PI的TF卡写挂了...  
这下好了...

### NAS

挑了几款

| 类别   | 型号                                      | 价格  |
|--------|-------------------------------------------|-------|
| 整机   | 天钡WTR Pro NAS型N100                     | 1364  |
| 内存   | 光威（Gloway）16GB DDR4 3200 笔记本内存条 战将系列 | 188   |
| 总价   |                                           | 1552  |
|        |                                           |       |
| 电源   | TT SFX 350W电源                           | 159   |
| 机箱   | 乔思伯（JONSBO）N4 黑色 NAS机箱           | 566   |
| 内存   | 光威（Gloway）32GB DDR5 4800 笔记本内存条 | 235   |
| 线材   | 晶华 高速SATA3.0硬盘数据连接线(3条)        | 14    |
| 主板   | 倍控N100 ITX NAS主板+挡板                  | 684   |
| 总价   |                                           | 1658  |
|        |                                           |       |
| 主板   | 畅网N100 开发板                           | 658   |
| 内存   | 光威（Gloway）32GB DDR5 4800 笔记本内存条 | 235   |
| 转接口 | M.2 NVME转SATA3（6口）送SATA线             | 115   |
| 电源   | DC电源                                    | 26    |
| 机箱   | 某宝3D打印塑料机箱                        | 150   |
| 总价   |                                           | 1184  |  


开发板的问题是塑料机箱是在是太丑了，下不去手。  
所以就买了ITX，装机的时候发现ITX跟内存不匹配。找了老板老板让我自己找别的内存条适配。最好是国外大厂的大颗粒内存条...
我就心想你也不看看你自己是不是国外大厂你就要我买国外大厂，搞笑么，退货...
最终入手成品机，geek-1...  
哦对，硬盘用的台式机退下来的一块1T的HDD和一块500G的SSD。
 

<图>


虽然我也不想打广告，但是N100芯片下，这个正品机箱确实不算贵，自己装配也差不多一个价格。加上如果不是买3D打印的而是直接买成品NAS机箱也得三五百。


### 装机


裸机不配任何系统，需要自己装。我这里选的是OpenMediaVault7，为啥不用TrueNAS？因为他不支持shell上去安装东西。  
装机步骤就不发了，网上到处都是，加上我也没截图，没东西可发。  
不过需要注意的是，装在硬盘上和装在USB上是两种安装方法。如果是装在硬盘上，直接下一步到结束就可以了。我这里选择的是安装到一块TF卡上。


如果我们选择安装到USB设备上，安装完之后启动时，需要先进入BIOS，关掉Security Boot。因为如果开启了Security Boot的话，就只能引导可信源的系统，可以理解为类似iPhone安装Appstore的应用。  
如果BIOS的引导方式是UEFI，我们需要改成传统的Latency引导，或者启用CMS兼容模式，因为OMV是基于Debain的系统，UEFI不能引导USB启动。  
But问了一下客服，这台机的只有UEFI引导...  


因此我改用了先安装Debain再安装OMV7的模式。OMV7安装在Debain12上，因此我需要安装Debain12。
安装过程依然跳过，到最后会问你要不要把系统时间设置为UTC时间--Yes，然后就跟你说安装好了，你要不要重启呀现在？-- 选No  
然后回回调安装界面，选启动一个shell进入命令行

```
chroot /target
dpkg-reconfigure grub-efi-amd64
```


之后会弹出几个界面，前面的都可以跳过，到大约第3个界面，他会问你`Force extra installation to the EFI removalbe media path?`这里选 Yes

<图>

我理解这里是Force将引导处理到可移除的媒体上，然后下一步下一步完成回调shell。输入`exit`退出shell，然后选`结束安装`重启系统，
这时就可以正常从USB引导进入系统了。

(https://wiki.debian.org/UEFI#Force_grub-efi_installation_to_the_removable_media_path)[https://wiki.debian.org/UEFI#Force_grub-efi_installation_to_the_removable_media_path]

进入系统后，联接好网络，替换好国内的apt源。然后用一个官方？的升级脚本安装OMV7 https://github.com/OpenMediaVault-Plugin-Developers/installScript 该脚本会安装OMV7和OMV-Extras。注意这里可能需要科学上网。

正常安装一般没有什么问题，大概等3分钟左右安装完成，就可以正常从Web进入OMV7了。

<图>

## 磁盘

因为使用方法比较单一，就是看剧。所以我这里选择的是挂载一整个HDD用来装资源，SSD分出100G用来给装其他App或者做Docker的容器，剩余300多G当做HDD的Cache。

LVM、RaidX、*FS 相关的概念和原理性的东西就不讲了网上都是。

首先装LVM，在插件里找到`openmediavault-lvm2 7.0-2`然后安装。这时在存储器下就可以看到LVM选项了。

<图> <图>

首选进入`磁盘`，把HDD和SSD都擦除一下

<图>

进入`LVM->多个物理卷`点击+添加物理卷，把刚才的HDD和SSD都添加进来

<图>

然后进入`LVM->多个卷组`点击+添加卷组，把刚刚的HDD和SSD都加到一个卷组里，卷组名称就随便写一个`volumegroup1`。如果我们要用SSD来给HDD做Cache，则一定需要将他们合到同一个卷组里。

进入`LVM->逻辑卷`

## Docker

安装Docker需要先安装OMV-Extras，前面脚本已经帮忙搞完了
