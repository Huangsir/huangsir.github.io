---
layout: post
title: "time.Tick 溢出"
date: "2022-07-05"
categories: [Golang]
---

最近看到 Rancher 上我们的一个 Pod 内存持续上涨，如图。

![](https://static.dingtalk.com/media/lQLPJxZx_M9GIPfNAkbNAyqwfj9S1xF9vQcCu9LQWkD5AA_810_582.png_620x10000q90.jpg?bizType=im)

4天从 100M 长到 1.5G，从这个并发量来看，增长的幅度很慢，应该是一个很微小的变量溢出导致的。

进到 Pod 里面看了一下，确实是占了不少内存，Prometheus 没统计错。

![](https://static.dingtalk.com/media/lQLPJxZx_eM-UCXMrs0FOrCpkzNZwukt7gK71JQBALwA_1338_174.png_620x10000q90.jpg?bizType=im)

二话不说上Pprof看，结果也非常直接。

![](https://static.dingtalk.com/media/lQLPJxZyFxgK0UDNASLNBPywiCMuZgq7rEwCu_3gDgAnAA_1276_290.png_620x10000q90.jpg?bizType=im)

一个叫 AutoHeartbeatRecord 的函数里，time.Ticker 溢出了，我们来看下这个函数。

![](https://static.dingtalk.com/media/lQLPJxZ3Xga1TQHNBcrNBhqwiEMNi1ichY8CxKM9eAAnAA_1562_1482.png_620x10000q90.jpg?bizType=im)

函数非常简单，而且整个函数只有一个 Ticker，那就没什么好说的了，点进去看一下。

![](https://static.dingtalk.com/media/lQLPJxZ3XkvZg5rNAh7NBhSwGj5Vna_RaDsCxKOwKYBuAA_1556_542.png_620x10000q90.jpg?bizType=im)

注释里提到说，如果 time.Tick 这个函数是没有办法 shutdown 的，所以他会有一个 leaks？既然有 leaks 为啥还要提供这样的函数出来？

翻阅了一下 stackoverflow，上面说 leaks means resource leak？不是 memory leak？

在特定情况下这个 resource 不需要了且不被系统回收的时候，才被称为 memory leak?

[https://stackoverflow.com/questions/68289916/will-time-tick-cause-memory-leak-when-i-never-need-to-stop-it](https://stackoverflow.com/questions/68289916/will-time-tick-cause-memory-leak-when-i-never-need-to-stop-it)

这样理解的话，那在 main 函数起个很大的 for 循环里面提供 tick.Tick，原则上就是没有 memory leak 了，而想我们这种在 handler 里使用 tick.Tick 的，应该都需要使用 time.NewTicker() 来代替，也就是这样

![](https://static.dingtalk.com/media/lQLPJxZ3Xga1TQHNBcrNBhqwiEMNi1ichY8CxKM9eAAnAA_1562_1482.png_620x10000q90.jpg?bizType=im)